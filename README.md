# API Prolink Facholi

![Ruby](https://img.shields.io/badge/ruby-3.4.5-red)
![Rails](https://img.shields.io/badge/rails-7.2-red)
![SQL Server](https://img.shields.io/badge/database-SQL%20Server-blue)
![Docker](https://img.shields.io/badge/docker-ready-brightgreen)

## üìã Vis√£o Geral

API REST desenvolvida em Ruby on Rails para integra√ß√£o com sistemas ERP, gerenciamento de produtos, ordens de produ√ß√£o, equipamentos e informa√ß√µes relacionadas ao processo produtivo industrial.

### üöÄ Stack Tecnol√≥gica

| Tecnologia | Vers√£o/Detalhes |
|------------|-----------------|
| **Framework** | Ruby on Rails 7.2 |
| **Ruby** | 3.4.5 |
| **Database** | SQL Server (dev/prod) / SQLite3 (testes) |
| **Autentica√ß√£o** | HTTP Basic Auth via Devise |
| **Pagina√ß√£o** | Pagy gem |
| **Containeriza√ß√£o** | Docker ready |
| **Service Objects** | Interactor pattern |

---

## üèóÔ∏è Arquitetura da API

### üìÅ Estrutura de Controllers

```
app/controllers/api/v1/
‚îú‚îÄ‚îÄ application_controller.rb              # Base controller com autentica√ß√£o
‚îú‚îÄ‚îÄ erp_products_controller.rb            # Gest√£o de produtos ERP
‚îú‚îÄ‚îÄ erp_unity_measurements_controller.rb  # Unidades de medida
‚îú‚îÄ‚îÄ erp_model_general_controller.rb       # Modelos gerais
‚îú‚îÄ‚îÄ erp_model_items_controller.rb         # Itens de modelos
‚îú‚îÄ‚îÄ erp_operation_general_controller.rb   # Roteiros gerais
‚îú‚îÄ‚îÄ erp_operation_items_controller.rb     # Itens de roteiros
‚îú‚îÄ‚îÄ erp_production_orders_controller.rb   # Ordens de produ√ß√£o
‚îú‚îÄ‚îÄ erp_reason_stops_controller.rb        # Motivos de parada
‚îú‚îÄ‚îÄ erp_stop_groups_controller.rb         # Grupos de parada
‚îú‚îÄ‚îÄ erp_shifts_controller.rb              # Turnos de trabalho
‚îú‚îÄ‚îÄ erp_equipments_controller.rb          # Equipamentos
‚îú‚îÄ‚îÄ lines_controller.rb                   # Linhas de produ√ß√£o
‚îî‚îÄ‚îÄ contingencia/                         # M√≥dulo de conting√™ncia
    ‚îú‚îÄ‚îÄ contingencia_products_controller.rb
    ‚îú‚îÄ‚îÄ contingencia_production_orders_controller.rb
    ‚îî‚îÄ‚îÄ contingencia_model_items_controller.rb
```

### üì¶ Estrutura de Models

```
app/models/
‚îú‚îÄ‚îÄ erp_product.rb                    # Produtos ERP com valida√ß√µes
‚îú‚îÄ‚îÄ erp_unity_measurement.rb          # Unidades de medida
‚îú‚îÄ‚îÄ erp_model_general.rb              # Modelos gerais
‚îú‚îÄ‚îÄ erp_model_item.rb                 # Itens de modelos
‚îú‚îÄ‚îÄ erp_operation_general.rb          # Roteiros gerais
‚îú‚îÄ‚îÄ erp_operation_item.rb             # Itens de roteiros
‚îú‚îÄ‚îÄ erp_production_order.rb           # Ordens de produ√ß√£o
‚îú‚îÄ‚îÄ erp_reason_stop.rb                # Motivos de parada
‚îú‚îÄ‚îÄ erp_stop_group.rb                 # Grupos de parada
‚îú‚îÄ‚îÄ erp_shift.rb                      # Turnos
‚îú‚îÄ‚îÄ erp_equipment.rb                  # Equipamentos
‚îú‚îÄ‚îÄ line.rb                           # Linhas de produ√ß√£o
‚îú‚îÄ‚îÄ contingencia_product.rb           # Produtos de conting√™ncia
‚îú‚îÄ‚îÄ contingencia_production_order.rb  # Ordens de conting√™ncia
‚îî‚îÄ‚îÄ contingencia_model_item.rb        # Itens de modelo conting√™ncia
```

---

## üîê Autentica√ß√£o

A API utiliza **HTTP Basic Authentication** para proteger todos os endpoints.

### üîë Como Autenticar

#### Headers Necess√°rios
```http
Authorization: Basic base64(email:password)
Content-Type: application/json
```

#### Credenciais Padr√£o (seeds.rb)
```yaml
Email: facholi@facholi.com
Password: adas32fav@#!32421
```

#### Exemplo de Requisi√ß√£o Autenticada
```bash
curl -X POST http://localhost:3000/api/v1/erp_products \
  -u "facholi@facholi.com:adas32fav@#!32421" \
  -H "Content-Type: application/json" \
  -d '{"erp_products": {"items": [...]}}'
```

> ‚ö†Ô∏è **IMPORTANTE**: TODOS os endpoints exigem autentica√ß√£o
> - ‚úÖ Todos os controllers herdam de `Api::V1::ApplicationController`
> - ‚úÖ Todos incluem `before_action :authorize_user!`
> - ‚úÖ Autentica√ß√£o via HTTP Basic com valida√ß√£o de usu√°rio/senha

---

## üìö Endpoints da API

### 1. Produtos ERP (`ErpProducts`)

**Controller:** `Api::V1::ErpProductsController`  
**Model:** `ErpProduct`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_products`
Cria ou atualiza produtos usando padr√£o upsert.

**L√≥gica do Controller:**
- Valida se `items` √© um array
- Para cada produto, executa `find_or_initialize_by(cod_pro:)`
- Atualiza todos os atributos via `assign_attributes`
- Salva em transa√ß√£o isolada

**Request Body:**
```json
{
  "erp_products": {
    "items": [
      {
        "cod_pro": "PROD001",           // Obrigat√≥rio - m√°x 14 caracteres
        "des_pro": "Descri√ß√£o Produto", // Obrigat√≥rio - m√°x 100 caracteres
        "cpl_pro": "Complemento",       // Opcional - m√°x 50 caracteres
        "uni_med": "KG",                // Obrigat√≥rio - m√°x 3 caracteres
        "cod_mod": "MOD001",            // Obrigat√≥rio - m√°x 14 caracteres
        "cod_rot": "ROT001",            // Obrigat√≥rio - m√°x 14 caracteres
        "cod_bar": "7891234567890",     // Opcional - m√°x 30 caracteres
        "des_teo": "Descri√ß√£o Te√≥rica", // Obrigat√≥rio - m√°x 50 caracteres
        "cod_cte": "CTE",               // Opcional - m√°x 3 caracteres
        "seq_ccp": "SEQ001"             // Opcional - m√°x 10 caracteres
      }
    ]
  }
}
```

**Response Success (200):**
```json
{
  "data": "Produtos processados com sucesso!"
}
```

#### `GET /api/v1/erp_products`
Lista todos os produtos com pagina√ß√£o.

**Funcionalidades:**
- Pagina√ß√£o via Pagy gem
- Ordena√ß√£o por `created_at: :desc`
- Retorna metadados de pagina√ß√£o

**Response (200):**
```json
{
  "pagination": {
    "page": 1,
    "pages": 10,
    "count": 100,
    "prev": null,
    "next": 2
  },
  "data": [
    {
      "id": 1,
      "cod_pro": "PROD001",
      "des_pro": "Descri√ß√£o do Produto",
      "cpl_pro": "Complemento",
      "uni_med": "KG",
      "cod_mod": "MOD001",
      "cod_rot": "ROT001",
      "cod_bar": "7891234567890",
      "des_teo": "Descri√ß√£o Te√≥rica",
      "cod_cte": "CTE",
      "seq_ccp": "SEQ001",
      "created_at": "2024-01-01T10:00:00.000Z",
      "updated_at": "2024-01-01T10:00:00.000Z"
    }
  ]
}
```

#### `GET /api/v1/erp_products/fetch_products_by_cod_linha`
Busca produtos por c√≥digo de linha atrav√©s de joins complexos.

**Query Parameter:** `cod_linha` (obrigat√≥rio)

**L√≥gica de Joins:**
```sql
JOIN erp_model_generals mg ON erp_products.cod_mod = mg.cod_mod
JOIN erp_model_items mi ON mi.cod_mod = mg.cod_mod  
JOIN equipment_lines el ON el.cod_eqp = mi.cod_balanca
WHERE el.cod_linha = ?
```

### 2. Unidades de Medida (`ErpUnityMeasurements`)

**Controller:** `Api::V1::ErpUnityMeasurementsController`  
**Model:** `ErpUnityMeasurement`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_unity_measurements`
**Request Body:**
```json
{
  "erp_uom": {
    "items": [
      {
        "uni_med": "KG",        // Obrigat√≥rio - m√°x 14 caracteres
        "des_med": "Quilograma" // Obrigat√≥rio - m√°x 100 caracteres
      }
    ]
  }
}
```

#### `GET /api/v1/erp_unity_measurements`
Lista todas as unidades de medida.

### 3. Modelos Gerais (`ErpModelGeneral`)

**Controller:** `Api::V1::ErpModelGeneralController`  
**Model:** `ErpModelGeneral`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_model_general`
**L√≥gica:** Upsert baseado em `cod_mod + ver_mod`

**Request Body:**
```json
{
  "erp_modelo": {
    "items": [
      {
        "cod_mod": "MOD001",             // Obrigat√≥rio - m√°x 14 caracteres
        "ver_mod": "1.0",                // Obrigat√≥rio - m√°x 10 caracteres
        "des_mod": "Descri√ß√£o do Modelo",// Obrigat√≥rio - m√°x 100 caracteres
        "uni_med": "KG",                 // Obrigat√≥rio - m√°x 3 caracteres
        "dat_ini": "2024-01-01",         // Obrigat√≥rio - data de in√≠cio
        "dat_fim": "2024-12-31",         // Obrigat√≥rio - data fim
        "qtd_bas": 100.5,                // Obrigat√≥rio - quantidade base
        "sit_mod": "A"                   // Obrigat√≥rio - situa√ß√£o (m√°x 1 caractere)
      }
    ]
  }
}
```

### 4. Itens do Modelo (`ErpModelItems`)

**Controller:** `Api::V1::ErpModelItemsController`  
**Model:** `ErpModelItem`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_model_items`
**L√≥gica:** Upsert baseado em `cod_mod + ver_mod + seq_mod + cod_cmp`

**Request Body:**
```json
{
  "erp_modelo_itens": {
    "items": [
      {
        "cod_mod": "MOD001",     // Obrigat√≥rio - m√°x 14 caracteres
        "ver_mod": "1.0",        // Obrigat√≥rio - vers√£o do modelo
        "seq_mod": 1,            // Obrigat√≥rio - sequ√™ncia
        "cod_cmp": "COMP001",    // Obrigat√≥rio - c√≥digo componente
        "qtd_uti": 10.5,         // Obrigat√≥rio - quantidade utilizada
        "cod_balanca": "BAL001"  // Obrigat√≥rio - c√≥digo balan√ßa
      }
    ]
  }
}
```

### 5. Roteiro Geral (`ErpOperationGeneral`)

**Controller:** `Api::V1::ErpOperationGeneralController`  
**Model:** `ErpOperationGeneral`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_operation_general`
**Request Body:**
```json
{
  "erp_roteiro_geral": {
    "items": [
      {
        "cod_rot": "ROT001",              // Obrigat√≥rio - m√°x 14 caracteres
        "ver_rot": "1.0",                 // Obrigat√≥rio - vers√£o
        "des_rot": "Descri√ß√£o do Roteiro",// Obrigat√≥rio - m√°x 100 caracteres
        "qtd_base": 100.0,                // Obrigat√≥rio - quantidade base
        "lot_tec": "LOTE001"              // Obrigat√≥rio - lote t√©cnico
      }
    ]
  }
}
```

### 6. Itens do Roteiro (`ErpOperationItems`)

**Controller:** `Api::V1::ErpOperationItemsController`  
**Model:** `ErpOperationItem`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_operation_items`
**Request Body:**
```json
{
  "erp_roteiro_itens": {
    "items": [
      {
        "cod_rot": "ROT001",  // Obrigat√≥rio - m√°x 14 caracteres
        "ver_rot": "1.0",     // Obrigat√≥rio - vers√£o
        "seq_rot": 1,         // Obrigat√≥rio - sequ√™ncia
        "tmp_fix": 30.5,      // Obrigat√≥rio - tempo fixo
        "tmp_prp": 15.2,      // Obrigat√≥rio - tempo proporcional
        "cod_cre": "CRE001"   // Obrigat√≥rio - c√≥digo CRE (m√°x 8 caracteres)
      }
    ]
  }
}
```

### 7. Ordens de Produ√ß√£o (`ErpProductionOrders`)

**Controller:** `Api::V1::ErpProductionOrdersController`  
**Model:** `ErpProductionOrder`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_production_orders`
**L√≥gica:** Upsert baseado em `num_orp` (n√∫mero √∫nico da OP)

**Request Body:**
```json
{
  "erp_ordem_prod": {
    "items": [
      {
        "cod_ori": "ORI",          // Obrigat√≥rio - origem (m√°x 3 caracteres)
        "num_orp": 123456,         // Obrigat√≥rio - n√∫mero da OP (√∫nico)
        "des_orp": "Descri√ß√£o OP", // Obrigat√≥rio - m√°x 50 caracteres
        "cod_pro": "PROD001",      // Obrigat√≥rio - c√≥digo produto
        "cod_mod": "MOD001",       // Obrigat√≥rio - c√≥digo modelo
        "cod_rot": "ROT001",       // Obrigat√≥rio - c√≥digo roteiro
        "ver_mod": "1.0",          // Obrigat√≥rio - vers√£o modelo
        "ver_rot": "1.0",          // Obrigat√≥rio - vers√£o roteiro
        "dat_emi": "2024-01-01",   // Obrigat√≥rio - data emiss√£o
        "dat_ent": "2024-01-31",   // Obrigat√≥rio - data entrega
        "qtd_prd": 1000.0,         // Obrigat√≥rio - quantidade produzir
        "num_pri": 1,              // Obrigat√≥rio - prioridade
        "qtd_bat": 100.0           // Obrigat√≥rio - quantidade batch
      }
    ]
  }
}
```

### 8. Motivos de Parada (`ErpReasonStops`)

**Controller:** `Api::V1::ErpReasonStopsController`  
**Model:** `ErpReasonStop`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_reason_stops`
**Request Body:**
```json
{
  "erp_motivos_parada": {
    "items": [
      {
        "cod_gru": "GRP001",               // Obrigat√≥rio - c√≥digo grupo
        "cod_mtv": "M01",                  // Obrigat√≥rio - c√≥digo motivo
        "des_mtv": "Manuten√ß√£o Preventiva",// Obrigat√≥rio - descri√ß√£o
        "abr_mtv": "MP",                   // Opcional - abrevia√ß√£o
        "par_lin": true,                   // Opcional - parada linha
        "tip_par": "TIPO1",                // Opcional - tipo parada
        "sit_mtv": "A"                     // Obrigat√≥rio - situa√ß√£o
      }
    ]
  }
}
```

### 9. Grupos de Parada (`ErpStopGroups`)

**Controller:** `Api::V1::ErpStopGroupsController`  
**Model:** `ErpStopGroup`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_stop_groups`
**Request Body:**
```json
{
  "erp_grupo_parada": {
    "items": [
      {
        "cod_gru": "GRP001",        // Obrigat√≥rio - c√≥digo
        "des_gru": "Grupo Manuten√ß√£o",// Obrigat√≥rio - descri√ß√£o
        "abr_gru": "MAN"            // Obrigat√≥rio - abrevia√ß√£o
      }
    ]
  }
}
```

### 10. Turnos (`ErpShifts`)

**Controller:** `Api::V1::ErpShiftsController`  
**Model:** `ErpShift`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_shifts`
**Request Body:**
```json
{
  "erp_turno": {
    "items": [
      {
        "cod_turno": "T01",         // Obrigat√≥rio - c√≥digo
        "des_turno": "Turno Manh√£", // Obrigat√≥rio - descri√ß√£o
        "hora_ini": "06:00",        // Obrigat√≥rio - hora in√≠cio
        "hora_fim": "14:00",        // Obrigat√≥rio - hora fim
        "dia": "Segunda-Sexta",     // Obrigat√≥rio - dias
        "tipo": "Normal"            // Obrigat√≥rio - tipo
      }
    ]
  }
}
```

### 11. Equipamentos (`ErpEquipments`)

**Controller:** `Api::V1::ErpEquipmentsController`  
**Model:** `ErpEquipment`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `POST /api/v1/erp_equipments`
**Request Body:**
```json
{
  "erp_equipamento": {
    "items": [
      {
        "cod_rec": "REC001",         // Obrigat√≥rio - c√≥digo recurso
        "cod_eqp": "EQP001",         // Obrigat√≥rio - c√≥digo equipamento
        "des_cre": "Centro Recurso", // Obrigat√≥rio - descri√ß√£o centro
        "des_eqp": "Equipamento 01", // Obrigat√≥rio - descri√ß√£o equip.
        "eqp_pai": "EQP000",         // Opcional - equipamento pai
        "eqp_pri": "EQP001"          // Opcional - equipamento principal
      }
    ]
  }
}
```

### 12. Linhas de Produ√ß√£o (`Lines`)

**Controller:** `Api::V1::LinesController`  
**Model:** `Line`  
**Autentica√ß√£o:** ‚úÖ Obrigat√≥ria

#### `GET /api/v1/lines`
Lista todas as linhas de produ√ß√£o.

**Funcionalidades:**
- Endpoint somente leitura
- Sem pagina√ß√£o (retorna todos os registros)

**Response (200):**
```json
{
  "data": [
    {
      "id": 1,
      "cod_linha": "L001",
      "des_linha": "Linha de Produ√ß√£o 1",
      "capacidade": 1000,
      "status": "ATIVA",
      "created_at": "2024-01-01T10:00:00.000Z",
      "updated_at": "2024-01-01T10:00:00.000Z"
    }
  ]
}
```

---

## üö® M√≥dulo de Conting√™ncia

### üéØ Vis√£o Geral

O m√≥dulo de conting√™ncia permite opera√ß√£o independente do ERP principal, garantindo continuidade operacional.

### üìã Fluxo de Conting√™ncia

```mermaid
graph TD
    A[1. Sele√ß√£o de Linha] --> B[2. Obter C√≥digo da Linha]
    B --> C[3. Buscar Produtos da Linha]
    C --> D[4. Selecionar Produto]
    D --> E[5. Criar Ordem de Produ√ß√£o]
    E --> F[6. Adicionar Itens √† OP]
    F --> G[7. Executar Produ√ß√£o]
```

### üìù Fluxo Detalhado

#### **1Ô∏è‚É£ PASSO 1: Listar Linhas Dispon√≠veis**

```bash
GET /api/v1/lines
```

**Response:**
```json
{
  "data": [
    {
      "id": 1,
      "cod_linha": "L001",
      "des_linha": "Linha de Produ√ß√£o 1",
      "capacidade": 1000,
      "status": "ATIVA"
    },
    {
      "id": 2,
      "cod_linha": "L002",
      "des_linha": "Linha de Produ√ß√£o 2",
      "capacidade": 800,
      "status": "ATIVA"
    }
  ]
}
```

#### **2Ô∏è‚É£ PASSO 2: Buscar Produtos por Linha**

```bash
GET /api/v1/erp_products/fetch_products_by_cod_linha?cod_linha=L001
```

**L√≥gica de Relacionamento:**
- Conecta produtos ‚Üí modelos gerais ‚Üí itens de modelo ‚Üí equipamentos ‚Üí linhas

**Response:**
```json
{
  "pagination": {
    "page": 1,
    "pages": 5,
    "count": 50,
    "prev": null,
    "next": 2
  },
  "data": [
    {
      "id": 1,
      "cod_pro": "PROD001",
      "des_pro": "Produto da Linha L001",
      "uni_med": "KG",
      "cod_mod": "MOD001",
      "cod_rot": "ROT001",
      "des_teo": "Produto para linha automatizada"
    }
  ]
}
```

#### **3Ô∏è‚É£ PASSO 3: Criar Produto de Conting√™ncia (Opcional)**

```bash
POST /api/v1/contingencia/contingencia_products
```

**Request:**
```json
{
  "contingencia_produto": {
    "cod_pro": "CONT_PROD001",
    "des_pro": "Produto de Conting√™ncia",
    "uni_med": "KG"
  }
}
```

**Valida√ß√µes:**
- ‚úÖ Verifica se a unidade de medida existe em `erp_unity_measurements`
- ‚úÖ C√≥digo do produto deve ser √∫nico
- ‚úÖ Todos os campos s√£o obrigat√≥rios

#### **4Ô∏è‚É£ PASSO 4: Criar Ordem de Produ√ß√£o de Conting√™ncia**

```bash
POST /api/v1/contingencia/contingencia_production_orders
```

**Request:**
```json
{
  "contingencia_ordem_prod": {
    "num_orp": 999001,
    "cod_linha": "L001",
    "cod_pro": "PROD001",
    "qtd_prd": 5000.0,
    "qtd_bat": 100.0
  }
}
```

**Status da OP:**

| Status | C√≥digo | Descri√ß√£o |
|--------|--------|-----------|
| `PENDENTE` | 0 | Status inicial autom√°tico |
| `RODANDO` | 1 | Em produ√ß√£o |
| `FINALIZADA` | 2 | Conclu√≠da |
| `CANCELADA` | 3 | Cancelada |

#### **5Ô∏è‚É£ PASSO 5: Adicionar Itens √† Ordem de Produ√ß√£o**

```bash
POST /api/v1/contingencia/contingencia_model_items
```

**Request:**
```json
{
  "contingencia_itens_ordem_prod": {
    "items": [
      {
        "num_orp": 999001,
        "cod_cmp": "COMP001",
        "seq_mod": 1,
        "qtd_uti": 10.5,
        "cod_balanca": "BAL001",
        "origem": "CONTINGENCIA"
      },
      {
        "num_orp": 999001,
        "cod_cmp": "COMP002",
        "seq_mod": 2,
        "qtd_uti": 20.0,
        "cod_balanca": "BAL002",
        "origem": "CONTINGENCIA"
      }
    ]
  }
}
```

### üéØ Vantagens do Sistema de Conting√™ncia

| Vantagem | Descri√ß√£o |
|----------|-----------|
| **‚úÖ Opera√ß√£o Independente** | Funciona mesmo com ERP offline, n√£o depende de conectividade externa |
| **‚úÖ Rastreabilidade Completa** | Campo "origem" identifica itens de conting√™ncia, hist√≥rico completo |
| **‚úÖ Flexibilidade Operacional** | Permite criar produtos emergenciais e OPs de conting√™ncia |
| **‚úÖ Integra√ß√£o Futura** | Dados podem ser sincronizados posteriormente com ERP |

### üìä Endpoints do M√≥dulo de Conting√™ncia

#### 13. Produtos de Conting√™ncia (`ContingenciaProducts`)

**Controller:** `Api::V1::Contingencia::ContingenciaProductsController`  
**Model:** `ContingenciaProduct`  
**Service:** `ContingenciaProductService::CreateContingenciaProduct`

#### 14. Ordens de Produ√ß√£o de Conting√™ncia (`ContingenciaProductionOrders`)

**Controller:** `Api::V1::Contingencia::ContingenciaProductionOrdersController`  
**Model:** `ContingenciaProductionOrder`  
**Service:** `ContingenciaProductionOrderService::CreateContingenciaProductionOrder`

#### 15. Itens de Modelo de Conting√™ncia (`ContingenciaModelItems`)

**Controller:** `Api::V1::Contingencia::ContingenciaModelItemsController`  
**Model:** `ContingenciaModelItem`

---

## üîÑ Fluxo Completo - Exemplo Pr√°tico

### Cen√°rio: Cria√ß√£o de uma OP de Conting√™ncia para Linha L001

```bash
# 1. Buscar Linhas Dispon√≠veis
curl -X GET http://localhost:3000/api/v1/lines \
  -u "facholi@facholi.com:adas32fav@#!32421"

# 2. Buscar Produtos da Linha L001
curl -X GET "http://localhost:3000/api/v1/erp_products/fetch_products_by_cod_linha?cod_linha=L001" \
  -u "facholi@facholi.com:adas32fav@#!32421"

# 3. Criar Ordem de Produ√ß√£o de Conting√™ncia
curl -X POST http://localhost:3000/api/v1/contingencia/contingencia_production_orders \
  -u "facholi@facholi.com:adas32fav@#!32421" \
  -H "Content-Type: application/json" \
  -d '{
    "contingencia_ordem_prod": {
      "num_orp": 999001,
      "cod_linha": "L001",
      "cod_pro": "PROD001",
      "qtd_prd": 5000.0,
      "qtd_bat": 100.0
    }
  }'

# 4. Adicionar Componentes √† OP
curl -X POST http://localhost:3000/api/v1/contingencia/contingencia_model_items \
  -u "facholi@facholi.com:adas32fav@#!32421" \
  -H "Content-Type: application/json" \
  -d '{
    "contingencia_itens_ordem_prod": {
      "items": [
        {
          "num_orp": 999001,
          "cod_cmp": "COMP001",
          "seq_mod": 1,
          "qtd_uti": 10.5,
          "cod_balanca": "BAL001",
          "origem": "CONTINGENCIA"
        }
      ]
    }
  }'

# 5. Verificar OP Criada
curl -X GET http://localhost:3000/api/v1/contingencia/contingencia_production_orders \
  -u "facholi@facholi.com:adas32fav@#!32421"
```

---

## üõ°Ô∏è Valida√ß√µes e Regras de Neg√≥cio

### M√≥dulo de Conting√™ncia

#### `ContingenciaProduct`
```ruby
validates :cod_pro, :uni_med, presence: true
validates :cod_pro, uniqueness: true
validate :uom_exists  # Valida se unidade existe em ErpUnityMeasurement
```

#### `ContingenciaProductionOrder`
```ruby
validates :num_orp, :cod_pro, :cod_linha, :qtd_prd, :qtd_bat, presence: true
validates :num_orp, uniqueness: true
validate :product_exists  # Valida se produto existe em ErpProduct
validate :line_exists     # Valida se linha existe em Line

enum status: {
  PENDENTE: '0',
  RODANDO: '1',
  FINALIZADA: '2',
  CANCELADA: '3'
}
```

---

## üìä Padr√µes de Response

### ‚úÖ Respostas de Sucesso

| Tipo | Status | Response |
|------|--------|----------|
| **Cria√ß√£o/Atualiza√ß√£o** | 200 | `{"data": "Mensagem de sucesso espec√≠fica"}` |
| **Cria√ß√£o com Service** | 201 | `{"data": "Recurso cadastrado com sucesso!"}` |
| **Listagem Simples** | 200 | `{"data": [...]}` |
| **Listagem com Pagina√ß√£o** | 200 | `{"pagination": {...}, "data": [...]}` |

### ‚ùå Respostas de Erro

| Tipo | Status | Response |
|------|--------|----------|
| **Autentica√ß√£o** | 401 | `{"error": "Credenciais inv√°lidas!"}` |
| **Valida√ß√£o** | 400 | `{"error": "O atributo items deve ser um vetor!"}` |
| **Processamento** | 422 | `{"error": "Mensagem espec√≠fica do service"}` |
| **Erro Interno** | 500 | `{"error": "Mensagem de erro ActiveRecord"}` |

---

## üóÑÔ∏è Configura√ß√£o do Banco de Dados

### üíª Desenvolvimento
```yaml
adapter: sqlserver
host: localhost
database: SUPERVISORIO_LINK
username: sa
password: Gr@fcet01
```

### üß™ Teste
```yaml
adapter: sqlite3
database: storage/test.sqlite3
```

### üöÄ Produ√ß√£o
```yaml
adapter: sqlserver
ssl: enabled (config.force_ssl = true)
# Use vari√°veis de ambiente:
DATABASE_HOST=seu_host
DATABASE_NAME=seu_banco
DATABASE_USER=seu_usuario
DATABASE_PASSWORD=sua_senha
```

---

## üìù Observa√ß√µes Importantes

### üîß L√≥gica de Processamento

| Padr√£o | Descri√ß√£o |
|--------|-----------|
| **Upsert Pattern** | Maioria dos endpoints ERP utilizam `find_or_initialize_by` |
| **Processamento em Lote** | Todos os endpoints aceitam arrays no campo `items` |
| **Transa√ß√µes** | Cada item √© processado em transa√ß√£o isolada |
| **Service Objects** | M√≥dulo de conting√™ncia utiliza Service Objects |
| **Valida√ß√µes** | Aplicadas em n√≠vel de Model com mensagens detalhadas |

### üìã Requisitos de Requisi√ß√£o

- `Content-Type: application/json` obrigat√≥rio
- `Authorization: HTTP Basic Auth` em todos os endpoints
- CSRF: Desabilitado para API controllers

## üöÄ Instala√ß√£o e Setup

### üì¶ Pr√©-requisitos

- Ruby 3.4.5
- Rails 7.2+
- SQL Server (desenvolvimento/produ√ß√£o)
- Bundler

### üõ†Ô∏è Passo a Passo

#### 1. Clone o reposit√≥rio
```bash
git clone [seu-repositorio]
cd prolink-facholi
```

#### 2. Instale as depend√™ncias
```bash
bundle install
```

#### 3. Configure o banco de dados
```bash
# Copie e ajuste as credenciais do banco
cp config/database.yml.example config/database.yml

# Crie o banco e rode as migrations
rails db:create
rails db:migrate
```

#### 4. Popule o banco com dados iniciais
```bash
rails db:seed
# Isso criar√° o usu√°rio padr√£o: facholi@facholi.com
```

#### 5. Inicie o servidor
```bash
rails server
# API dispon√≠vel em http://localhost:3000
```

---

## üê≥ Docker

O projeto inclui Dockerfile para deployment:

```bash
# Build da imagem
docker build -t prolink-facholi .

# Executar container
docker run -d -p 3000:3000 \
  -e RAILS_MASTER_KEY=[sua_master_key] \
  -e DATABASE_HOST=[seu_host] \
  -e DATABASE_NAME=[seu_banco] \
  -e DATABASE_USER=[seu_usuario] \
  -e DATABASE_PASSWORD=[sua_senha] \
  prolink-facholi
```

---

## üíª Exemplos de Uso com cURL

### üîë Autentica√ß√£o Base
```bash
# Todas as requisi√ß√µes devem incluir:
-u "facholi@facholi.com:adas32fav@#!32421"
```

### üì¶ Criar Produtos
```bash
curl -X POST http://localhost:3000/api/v1/erp_products \
  -u "facholi@facholi.com:adas32fav@#!32421" \
  -H "Content-Type: application/json" \
  -d '{
    "erp_products": {
      "items": [{
        "cod_pro": "PROD001",
        "des_pro": "Produto Teste",
        "uni_med": "KG",
        "cod_mod": "MOD001",
        "cod_rot": "ROT001",
        "des_teo": "Descri√ß√£o Te√≥rica"
      }]
    }
  }'
```

### üìè Listar Unidades de Medida
```bash
curl -X GET http://localhost:3000/api/v1/erp_unity_measurements \
  -u "facholi@facholi.com:adas32fav@#!32421"
```

### üìã Criar Ordem de Produ√ß√£o
```bash
curl -X POST http://localhost:3000/api/v1/erp_production_orders \
  -u "facholi@facholi.com:adas32fav@#!32421" \
  -H "Content-Type: application/json" \
  -d '{
    "erp_ordem_prod": {
      "items": [{
        "cod_ori": "ORI",
        "num_orp": 123456,
        "des_orp": "OP Teste",
        "cod_pro": "PROD001",
        "cod_mod": "MOD001",
        "cod_rot": "ROT001",
        "ver_mod": "1.0",
        "ver_rot": "1.0",
        "dat_emi": "2024-01-01",
        "dat_ent": "2024-01-31",
        "qtd_prd": 1000,
        "num_pri": 1,
        "qtd_bat": 100
      }]
    }
  }'
```

---

## üì¶ Estrutura de Tabelas Adicionais

### Tabelas de Conting√™ncia
- `contingencia_production_orders` - Ordens de produ√ß√£o de conting√™ncia
- `contingencia_model_items` - Itens de modelo de conting√™ncia
- `contingencia_products` - Produtos de conting√™ncia

### Tabelas de Produ√ß√£o
- `bateladas` - Controle de bateladas de produ√ß√£o
- `batelada_passos` - Passos/etapas de cada batelada
- `lines` - Linhas de produ√ß√£o
- `equipment_lines` - Rela√ß√£o equipamento-linha
- `line_stops` - Paradas de linha

### Tabelas de Ensacamento
- `bagging_stops` - Paradas de ensacadeira
- `bagging_weights` - Pesos de ensacamento

---

## üîß Troubleshooting

### ‚ùå Erro de Autentica√ß√£o
```json
{"error": "Credenciais inv√°lidas!"}
```
**Solu√ß√£o:** Verifique se est√° usando as credenciais corretas do seeds.rb

### ‚ùå Erro de Valida√ß√£o
```json
{"error": "O atributo items dos [recurso] deve ser um vetor!"}
```
**Solu√ß√£o:** Certifique-se de enviar um array no campo items

### ‚ùå Erro de Database
Se encontrar erros de conex√£o com SQL Server:
1. Verifique se o SQL Server est√° rodando
2. Confirme as credenciais em `config/database.yml`
3. Teste a conex√£o: `rails db:migrate`

### ‚ùå Erro de Service Object
```json
{"error": "Unidade de Medida n√£o encontrada!"}
```
**Solu√ß√£o:** Para conting√™ncia, certifique-se que a unidade de medida existe em `ErpUnityMeasurement`

---

## üìä M√©tricas e Monitoramento

### üìù Logs
- **Desenvolvimento:** Console output
- **Produ√ß√£o:** `log/production.log` ou STDOUT (Docker)

### üè• Health Check
```bash
curl http://localhost:3000/up
```

---

## üîÆ Pr√≥ximas Features

- [ ] Versionamento de API (v2)
- [ ] Rate limiting
- [ ] Swagger/OpenAPI documentation
- [ ] WebSocket support para real-time updates
- [ ] Corre√ß√£o dos bugs identificados
- [ ] Implementa√ß√£o de soft deletes
- [ ] Auditoria de mudan√ßas
- [ ] Cache Redis para consultas frequentes
- [ ] Dashboard de monitoramento de conting√™ncia
- [ ] Sincroniza√ß√£o autom√°tica com ERP principal
- [ ] Relat√≥rios de opera√ß√µes de conting√™ncia

---

## üìÑ Licen√ßa

Proprietary - Todos os direitos reservados

---

## üë• Suporte

Para quest√µes e suporte, entre em contato com a equipe de desenvolvimento.