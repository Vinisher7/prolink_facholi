<div class="card">
  <div class="card-header">
    <h2 class="card-title">Ordem de Contingência #<%= @contingencia_ordem.num_orp %></h2>
    <p class="card-subtitle">
      Detalhes da ordem de produção de contingência
    </p>
    <div class="card-actions">
      <%= link_to "Editar", edit_contingencia_ordem_path(@contingencia_ordem), class: "btn btn-primary" %>
      <%= link_to "Voltar", contingencia_ordens_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <div class="details-container">
    <div class="details-grid">
      <div class="detail-item">
        <label class="detail-label">Número da OP:</label>
        <span class="detail-value"><%= @contingencia_ordem.num_orp %></span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Linha de Produção:</label>
        <span class="detail-value"><%= @contingencia_ordem.cod_linha %></span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Código do Produto:</label>
        <span class="detail-value"><%= @contingencia_ordem.cod_pro %></span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Quantidade a Produzir:</label>
        <span class="detail-value"><%= @contingencia_ordem.qtd_prd %></span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Quantidade por Batch:</label>
        <span class="detail-value"><%= @contingencia_ordem.qtd_bat %></span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Status:</label>
        <span class="status-badge status-<%= @contingencia_ordem.status&.downcase %>">
          <%= @contingencia_ordem.status %>
        </span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Data de Criação:</label>
        <span class="detail-value"><%= @contingencia_ordem.created_at.strftime("%d/%m/%Y às %H:%M") %></span>
      </div>

      <div class="detail-item">
        <label class="detail-label">Última Atualização:</label>
        <span class="detail-value"><%= @contingencia_ordem.updated_at.strftime("%d/%m/%Y às %H:%M") %></span>
      </div>
    </div>
  </div>

  <!-- Seção para adicionar itens à ordem -->
  <div class="card mt-4">
    <div class="card-header">
      <h3 class="card-title">Adicionar Itens à Ordem</h3>
    </div>
    <div class="form-container">
      <form id="add-items-form">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Código do Produto:</label>
            <input type="text" id="item-cod-pro" class="form-input" placeholder="Código do produto">
          </div>
          <div class="form-group">
            <label class="form-label">Quantidade:</label>
            <input type="number" id="item-quantidade" class="form-input" placeholder="Quantidade" step="0.01">
          </div>
          <div class="form-group">
            <button type="button" id="add-item-btn" class="btn btn-primary">Adicionar Item</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById('add-item-btn').addEventListener('click', function() {
    const codPro = document.getElementById('item-cod-pro').value;
    const quantidade = document.getElementById('item-quantidade').value;

    if (!codPro || !quantidade) {
      alert('Por favor, preencha todos os campos');
      return;
    }

    const items = [{
      cod_pro: codPro,
      quantidade: parseFloat(quantidade)
    }];

    fetch(`/contingencia-ordens/<%= @contingencia_ordem.id %>/add_items`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ items: items })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        alert(data.message);
        document.getElementById('item-cod-pro').value = '';
        document.getElementById('item-quantidade').value = '';
      } else if (data.error) {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao adicionar item');
    });
  });
</script>